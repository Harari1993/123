{"version":3,"file":"map-events-manager.js","sourceRoot":"","sources":["map-events-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { Observable, Subject } from 'rxjs';\r\nimport { CesiumService } from '../cesium/cesium.service';\r\nimport { CesiumEventBuilder } from './cesium-event-builder';\r\nimport { EventRegistrationInput } from './event-registration-input';\r\nimport { DisposableObservable } from './disposable-observable';\r\nimport { PickOptions } from './consts/pickOptions.enum';\r\nimport { CesiumEvent } from './consts/cesium-event.enum';\r\nimport { CesiumEventModifier } from './consts/cesium-event-modifier.enum';\r\nimport { UtilsService } from '../../utils/utils.service';\r\nimport { PlonterService } from '../plonter/plonter.service';\r\n\r\n/**\r\n * Manages all map events. Notice events will run outside of Agular zone\r\n * __usage:__\r\n * ```\r\n * MapEventsManagerService.register({event, modifier, priority, entityType, pickOption}).subscribe()\r\n * ```\r\n * __param:__ {CesiumEvent} event\r\n * __param:__ {CesiumEventModifier} modifier\r\n * __param:__ priority - the bigger the number the bigger the priority. default : 0.\r\n * __param:__ entityType - entity type class that you are interested like (Track). the class must extends AcEntity\r\n * __param:__ pickOption - self explained\r\n */\r\n\r\nexport class MapEventsManagerService {\r\n\r\n\tprivate scene;\r\n\tprivate eventRegistrations = new Map<string, Registration[]>();\r\n\r\n\tconstructor(cesiumService: CesiumService,\r\n\t            private eventBuilder: CesiumEventBuilder,\r\n\t            private plonterService: PlonterService) {\r\n\t\tthis.scene = cesiumService.getScene();\r\n\t}\r\n\r\n\tregister(input: EventRegistrationInput): DisposableObservable<EventResult> {\r\n\t\tif (this.scene === undefined) {\r\n\t\t\tthrow 'CesiumService has not been initialized yet - MapEventsManagerService must be injected  under ac-map';\r\n\t\t}\r\n\r\n\t\tinput.pick = input.pick || PickOptions.NO_PICK;\r\n\t\tinput.priority = input.priority || 0;\r\n\r\n\t\tif (input.entityType && input.pick === PickOptions.NO_PICK) {\r\n\t\t\tthrow 'MapEventsManagerService: can\\'t register an event with entityType and PickOptions.NO_PICK - It doesn\\'t make sense ';\r\n\t\t}\r\n\r\n\t\tconst eventName = CesiumEventBuilder.getEventFullName(input.event, input.modifier);\r\n\r\n\t\tif (!this.eventRegistrations.has(eventName)) {\r\n\t\t\tthis.eventRegistrations.set(eventName, []);\r\n\t\t}\r\n\r\n\t\tconst eventRegistration = this.createEventRegistration(input.event, input.modifier, input.entityType, input.pick, input.priority);\r\n\t\tconst registrationObservable: any = eventRegistration.observable;\r\n\t\tregistrationObservable.dispose = () => this.disposeObservable(eventRegistration, eventName);\r\n\t\tthis.eventRegistrations.get(eventName).push(eventRegistration);\r\n\r\n\t\tthis.sortRegistrationsByPriority(eventName);\r\n\t\treturn <DisposableObservable<EventResult>> registrationObservable;\r\n\t}\r\n\r\n\tprivate disposeObservable(eventRegistration, eventName) {\r\n\t\teventRegistration.stopper.next(1);\r\n\t\tconst registrations = this.eventRegistrations.get(eventName);\r\n\t\tconst index = registrations.indexOf(eventRegistration);\r\n\t\tif (index !== -1) {\r\n\t\t\tregistrations.splice(index, 1);\r\n\t\t}\r\n\t\tthis.sortRegistrationsByPriority(eventName);\r\n\t}\r\n\r\n\tprivate sortRegistrationsByPriority(eventName: string) {\r\n\t\tconst registrations = this.eventRegistrations.get(eventName);\r\n\t\tregistrations.sort((a, b) => b.priority - a.priority);\r\n\t\tif (registrations.length === 0) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Active registrations by priority\r\n\t\tconst currentPriority = registrations[0].priority;\r\n\t\tregistrations.forEach((registration) => {\r\n\t\t\tregistration.isPaused = registration.priority < currentPriority;\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tprivate createEventRegistration(event: CesiumEvent, modifier: CesiumEventModifier,\r\n\t                                entityType, pickOption: PickOptions, priority: number): Registration {\r\n\t\tconst cesiumEventObservable = this.eventBuilder.get(event, modifier);\r\n\t\tconst stopper = new Subject();\r\n\r\n\t\tlet registration = new Registration(undefined, stopper, priority, false);\r\n\t\tlet observable: Observable<EventResult>;\r\n\r\n\t\tobservable = cesiumEventObservable\r\n\t\t\t.filter(() => !registration.isPaused)\r\n\t\t\t.map((movement) => this.triggerPick(movement, pickOption))\r\n\t\t\t.filter((result) => result.primitives !== null)\r\n\t\t\t.map((picksAndMovement) => this.addEntities(picksAndMovement, entityType, pickOption))\r\n\t\t\t.filter((result) => result.entities !== null)\r\n\t\t\t.switchMap((entitiesAndMovement) => this.plonter(entitiesAndMovement, pickOption))\r\n\t\t\t.takeUntil(stopper);\r\n\r\n\t\tregistration.observable = observable;\r\n\t\treturn registration;\r\n\t}\r\n\r\n\tprivate triggerPick(movement: any, pickOptions: PickOptions) {\r\n\t\tlet picks: any = [];\r\n\t\tswitch (pickOptions) {\r\n\t\t\tcase PickOptions.PICK_ONE:\r\n\t\t\tcase PickOptions.PICK_ALL:\r\n\t\t\t\tpicks = this.scene.drillPick(movement.endPosition);\r\n\t\t\t\tpicks = picks.length === 0 ? null : picks;\r\n\t\t\t\tbreak;\r\n\t\t\tcase PickOptions.PICK_FIRST:\r\n\t\t\t\tconst pick = this.scene.pick(movement.endPosition);\r\n\t\t\t\tpicks = pick === undefined ? null : [pick];\r\n\t\t\t\tbreak;\r\n\t\t\tcase PickOptions.NO_PICK:\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\r\n\t\treturn {movement: movement, primitives: picks};\r\n\t}\r\n\r\n\tprivate addEntities(picksAndMovement, entityType, pickOption: PickOptions): EventResult {\r\n\t\tlet entities = [];\r\n\t\tif (pickOption !== PickOptions.NO_PICK) {\r\n\t\t\tif (entityType) {\r\n\t\t\t\tentities = picksAndMovement.primitives.map((pick) => pick.primitive.acEntity).filter((acEntity) => {\r\n\t\t\t\t\treturn acEntity && acEntity instanceof entityType;\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tentities = picksAndMovement.primitives.map((pick) => pick.primitive.acEntity);\r\n\t\t\t}\r\n\r\n\t\t\tentities = UtilsService.unique(entities);\r\n\t\t\tif (entities.length === 0) {\r\n\t\t\t\tentities = null;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn Object.assign(picksAndMovement, {entities: entities});\r\n\t}\r\n\r\n\tprivate plonter(entitiesAndMovement: EventResult, pickOption: PickOptions): Observable<EventResult> {\r\n\t\tif (pickOption === PickOptions.PICK_ONE && entitiesAndMovement.entities.length > 1) {\r\n\t\t\treturn this.plonterService.plonterIt(entitiesAndMovement);\r\n\t\t} else {\r\n\t\t\treturn Observable.of(entitiesAndMovement);\r\n\t\t}\r\n\t}\r\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: CesiumService, },\n{type: CesiumEventBuilder, },\n{type: PlonterService, },\n];\n}\r\n\r\nexport interface EventResult {\r\n\tmovement: any;\r\n\tprimitives: any[];\r\n\tentities: any[];\r\n}\r\nclass Registration {\r\n\tconstructor(public observable: Observable<EventResult>,\r\n\t            public  stopper: Subject<any>,\r\n\t            public  priority: number,\r\n\t            public  isPaused: boolean) {\r\n\t}\r\n}\r\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}